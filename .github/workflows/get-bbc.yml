name: Get BBC Podcasts

on:
  schedule:
    - cron: '00 20 * * 5'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Last run time
        run: |
          cd _feeds
          sed -i -e "s/fetched:.*$/fetched: $(date +'%Y-%m-%dT%H:%M:%S%z')/" fnc.xml

      - name: Install ffmpeg + AtomicParsley
        run: |
          sudo apt-get update
          sudo apt-get install -y atomicparsley ffmpeg --fix-missing

      - name: Setup Perl local lib
        run: |
          PERL_LOCAL_LIB_ROOT="$HOME/perl5"
          echo "PERL_LOCAL_LIB_ROOT=$PERL_LOCAL_LIB_ROOT" >> "$GITHUB_ENV"
          echo "PERL5LIB=$PERL_LOCAL_LIB_ROOT/lib/perl5" >> "$GITHUB_ENV"
          echo "PERL_MB_OPT=--install_base \"$PERL_LOCAL_LIB_ROOT/\"" >> "$GITHUB_ENV"
          echo "PERL_MM_OPT=INSTALL_BASE=$PERL_LOCAL_LIB_ROOT" >> "$GITHUB_ENV"
          echo "PATH=$PERL_LOCAL_LIB_ROOT/bin:$PATH" >> "$GITHUB_ENV"

      - name: Install cpanm
        run: cpan App::cpanminus

      - name: Install Perl modules
        run: |
          cpanm --notest LWP
          cpanm --notest LWP::Protocol::https
          cpanm --notest Mojolicious
          cpanm --notest XML::LibXML
          cpanm --notest CGI

      - name: Install Get-iPlayer
        run: |
          wget https://raw.githubusercontent.com/get-iplayer/get_iplayer/master/get_iplayer
          install -m 755 ./get_iplayer /usr/local/bin

      - name: Prepare media folder
        run: |
          mkdir -p media

      - name: Get podcasts
        run: |
          # List of PIDs to process
          PIDS=(
            "p02pc9pj"   # example FNC BBC PID
            # add more PIDs here
          )

          for PID in "${PIDS[@]}"; do
            echo "Processing PID: $PID"

            cd media

            # Determine latest episode PID
            EP_PID=$(get_iplayer --pid=$PID --pid-recursive-list | tail -2 | head -1 | awk '{print $NF}')
            echo "Episode PID: $EP_PID"

            # Download episode
            get_iplayer --file-prefix="${PID}" --pid="$EP_PID"

            # Convert downloaded m4a â†’ mp3
            FILE_M4A=$(ls ${PID}*.m4a | head -1)
            OUT_MP3="${PID}.mp3"

            ffmpeg -i "$FILE_M4A" -codec:v copy -codec:a libmp3lame -q:a 2 "$OUT_MP3"

            # Metadata JSON output
            DURATION=$(ffprobe -v error -show_entries format=duration -of default=nk=1:nw=1 "$OUT_MP3")
            NOW=$(date -Iseconds)
            FULLPATH="$(pwd)/${OUT_MP3}"

            cat <<EOF > ../_data/${PID}.json
                  {
                    "podcast": {
                      "title": "BBC Podcast $PID",
                      "short": "$PID",
                      "source": "https://www.bbc.co.uk/programmes/$PID",
                      "destination": "media",
                      "extension": "mp3",
                      "trim": 0
                    },
                    "episode": {
                      "title": null,
                      "pubDate": null,
                      "description": null,
                      "guid": "$EP_PID",
                      "link": "https://www.bbc.co.uk/programmes/$EP_PID",
                      "media_url": null
                    },
                    "output": {
                      "file": "$FULLPATH",
                      "duration_seconds": $DURATION,
                      "downloaded_at": "$NOW"
                    }
                  }
                  EOF

            cd ..
          done

      - name: Commit downloads
        run: |
          git pull
          git add media/*.mp3
          git add media/json/*.json
          git add *.xml
          git config --global user.name 'Poddy'
          git config --global user.email 'poddy@users.noreply.github.com'
          git commit -am "Podcast batch fetch"
          git push
