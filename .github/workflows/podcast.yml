name: Update Podcasts

on:
  schedule:
    - cron: "55 20 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------------------------------------
    # 1. CHECKOUT
    # -----------------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    # -----------------------------------------------------------
    # 2. CACHE PERL + CPANM
    # -----------------------------------------------------------
    - name: Cache Perl modules
      uses: actions/cache@v4
      with:
        path: |
          ~/perl5
          ~/.cpanm
        key: ${{ runner.os }}-perl-${{ hashFiles('fetch_podcasts.py', 'podcasts.yml') }}
        restore-keys: |
          ${{ runner.os }}-perl-

    # -----------------------------------------------------------
    # 3. SYSTEM DEPS
    # -----------------------------------------------------------
    - name: Install system deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cpanminus \
          atomicparsley \
          ffmpeg \
          libxml2 libxml2-dev libxslt1-dev

    # -----------------------------------------------------------
    # 4. PERL LOCAL::LIB SETUP
    # -----------------------------------------------------------
    - name: Setup Perl local::lib
      run: |
        echo "PERL_LOCAL_LIB_ROOT=$HOME/perl5" >> $GITHUB_ENV
        echo "PERL5LIB=$HOME/perl5/lib/perl5" >> $GITHUB_ENV
        echo "PERL_MB_OPT=--install_base=$HOME/perl5" >> $GITHUB_ENV
        echo "PERL_MM_OPT=INSTALL_BASE=$HOME/perl5" >> $GITHUB_ENV
        echo "PATH=$HOME/perl5/bin:$PATH" >> $GITHUB_ENV

    # -----------------------------------------------------------
    # 5. INSTALL REQUIRED PERL MODULES
    # -----------------------------------------------------------
    - name: Install Perl modules
      run: |
        cpanm --quiet --notest \
          LWP \
          LWP::Protocol::https \
          Mojolicious \
          XML::LibXML \
          CGI

    # -----------------------------------------------------------
    # 6. INSTALL GET_IPLAYER
    # -----------------------------------------------------------
    - name: Install get_iplayer
      run: |
        curl -fsSL -o get_iplayer \
          https://raw.githubusercontent.com/get-iplayer/get_iplayer/master/get_iplayer
        chmod +x get_iplayer
        sudo mv get_iplayer /usr/local/bin/

    # -----------------------------------------------------------
    # 7. DEBUG ENV
    # -----------------------------------------------------------
    - name: Debug Perl & environment
      run: |
        echo "=== PATH ==="
        echo "$PATH"
        which perl
        which cpanm || true
        ls -R $HOME/perl5 || true
        get_iplayer --basic-help || echo "get_iplayer FAILED"

    # -----------------------------------------------------------
    # 8. PYTHON DEPS
    # -----------------------------------------------------------
    - name: Install Python deps
      run: |
        pip3 install --quiet feedparser pydub requests pyyaml

    # -----------------------------------------------------------
    # 9. RUN SCRIPT
    # -----------------------------------------------------------
    - name: Run fetch script
      run: python3 fetch_podcasts.py

    # -----------------------------------------------------------
    # 10. COMMIT CHANGES
    # -----------------------------------------------------------
    - name: Commit changes
      run: |
        git config --global user.email "github-actions@users.noreply.github.com"
        git config --global user.name "GitHub Actions"
        git pull
        git add media/ || true
        git add _feeds/ || true
        git add state.yml || true
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update podcasts"
          git push
        fi
