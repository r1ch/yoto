- name: Setup Perl local lib
  shell: bash
  run: |
    echo "PERL_LOCAL_LIB_ROOT=$HOME/perl5" >> $GITHUB_ENV
    echo "PERL5LIB=$HOME/perl5/lib/perl5" >> $GITHUB_ENV
    echo "PERL_MB_OPT=--install_base $HOME/perl5" >> $GITHUB_ENV
    echo "PERL_MM_OPT=INSTALL_BASE=$HOME/perl5" >> $GITHUB_ENV
    echo "PATH=$HOME/perl5/bin:\$PATH" >> $GITHUB_ENV

- name: Install cpanm
  shell: bash
  run: bash -l -c "cpan App::cpanminus"

- name: Install Perl modules
  shell: bash
  run: |
    bash -l -c "cpanm --quiet --notest LWP"
    bash -l -c "cpanm --quiet --notest LWP::Protocol::https"
    bash -l -c "cpanm --quiet --notest Mojolicious"
    bash -l -c "cpanm --quiet --notest XML::LibXML"
    bash -l -c "cpanm --quiet --notest CGI"

- name: Debug Perl & get_iplayer environment
  shell: bash
  run: |
    echo "=== PATH ==="
    echo "$PATH"
    which perl
    which cpanm
    ls -R $HOME/perl5
    get_iplayer --version || echo "get_iplayer FAILED"

- name: Run fetch script
  shell: bash
  run: bash -l -c "python3 fetch_podcasts.py"
